# libshutup
libshutupは日本語のように、同じ意味の言葉を色々なやり方で記述できる言語における禁止語句のブロックを効率的に行うためにデザインされたC++で書かれたライブラリです.
for English readme. go to [here](https://github.com/umegaya/libshutup/README.md)

## ハイライト
- 辞書に登録した単語を、表記の揺れを考慮しつつマッチングします, 例えば日本語(JP)モードにおいて、 "badword" は以下をブロックします。
  - "BａDworD" (大文字小文字、全角半角文字の違いを無視)
  - "b　a(d)w-o-r-d" (間に挟まった記号を無視)
- それに加えて、日本語 "バッドワード" は以下もブロックします。
  - "ﾊﾞｯﾄﾞﾜｰﾄﾞ" (半角カナ)
  - "ばっどわーど" (ひらがな)
  - "ﾊﾞｯドわーﾄﾞ" (文字種の混合)
  - "baddo wa-do" (ローマ字)
- 拡張されたPatricia木により、メモリおよび実行効率の良いマッチングができます。
- C++バージョンのライブラリはすべてのメモリをアロケーター経由で割り当てることができます。
- 適用範囲のことなる3つのレイヤーの組み合わせによってフレキシブルな禁止語句のマッチングが可能です。これにより他の言語についても有効なブロック処理を比較的簡単に構築可能です。
  - normalize
    - ignore
  - alias
  - synonym

## プラットフォーム
- iOS
- Android
- OSX (bundle)

## インストール
```
git clone https://github.com/umegaya/libshutup
cd libshutup
make ios
make android
make bundle # osx bundle
make lib # osx static library (may work in linux)
```

## 使い方
``` C++
#include "checker.h"

int main(int argc, char *argv[]) {
	shutup::Checker c(
		"jp", /* 組み込みの日本語向け禁止文字チェックルーチンを利用する。 */
		nullptr/* 標準のmalloc,free,reallocを使う、もしくはshutup_allocatorのポインタを指定することでカスタムアロケーターを利用する. */
	);
	c.add("アイウエオ");
	c.add("abc");
	assert(c.should_filter("a-B-c"));
	assert(c.should_filter("あいうえお"));
	assert(!c.should_filter("bbc"));
	assert(!c.should_filter("あいうえこ"));
}
```

## 禁止語句マッチングの仕組み
- libshutupは文字列の同一性を判定するための幾つかの抽象的な機能を用意し、その組み合わせによって任意の禁止語句のブロックの仕様を実現するようにしています。
- 以下にその概念を説明します。

### normalize: 正規化
- いかなる場合でも同一視できる文字のグループを指定し、入力に含まれている文字をそれと同一視される文字グループに含まれる要素の１つに変換する機能です。
- JPモードにおいては、以下のような正規化のグループが指定されています。
  - 全角/半角, 大文字/小文字の同じ種類のアルファベットおよび数字のグループ => 半角小文字および数字に変換
  - カタカナ、半角カナのグループ => 全角カナに変換 

### ignore: 無視
- normalizeの特殊な例で、効率的な禁止語句マッチのためには必ず必要になってくるため独立したカテゴリーとして説明します。
- 例えば[badword]に対して[b a d w o r d]のように空白を含んでも人間は意味を解釈することができてしまうため、こういった文字として認識されない文字は取り除いてからマッチングを行わないといくらでもフィルターを抜けられてしまいます。
- そのため、空文字列に同一視される文字のグループを組み込みで設定できるようにしており、これをignoreと呼んでいます。
- JPモードにおいては以下のように設定されています。
```
"-+!\"#$%%&()*/,:;<=>?@[\\]^_{|}~ "
"ｰ" //half kata hyphen
"、。，．・：；？！゛゜´｀¨＾￣＿ヽヾゝゞ〃仝々〆〇ー‐／＼～∥｜…‥"
"‘’“”（）〔〕［］｛｝〈〉《》「」『』【】＋－±×÷＝≠＜＞≦≧∞∴"
"♂♀°′″℃￥＄￠￡％＃＆＊＠§☆★○●◎◇◆□■△▲▽▼※〒→←↑↓"
"〓∈∋⊆⊇⊂⊃∪∩∧∨￢⇒⇔∀∃∠⊥⌒∂∇≡≒≪≫√∽∝∵∫∬Å‰♯♭"
"♪†‡¶◯〝〟≒≡∫∮√⊥∠∵∩∪　"
```

### alias: 別名
- normalizeの同一視は文字列すべてに適用されてしまうので、予測できない誤マッチングが多くなりがちだと考えられます。例えば、ソ(そ)とン(ん)などのように、あらゆる場所で一致させると問題がある一方で、一部の単語を記述する際には頻繁に置き換えて使われる（神聖なgithubには書けませんが）文字もあります。
- またこの例ではン=>ソという同一視は重要ですが、逆はそれほど重要ではありません。normalizeではこういった非対称性に対応できません。
- こういった問題に対応するためにaliasが存在します。aliasは文字に対応づけられた文字列のリストで、辞書に含まれる文字にマッチングする際に辞書の文字そのものだけでなく、入力がその文字のaliasのどれかにマッチしていないかも調べます。そして、aliasにマッチした際にももともとの辞書にあった文字にマッチしたものとして処理を続けます。
- JPモードにおいては、以下のようなエイリアスが設定されています。
  - カタカナとそれに対応するひらがな、またその逆(aliasは一方向リンクであることに注意してください)
  - ン => ソ (逆はaliasではありません)

### synonym: 類義語
- aliasとnormalizeでかなりのパターンの表記の揺れをカバーできると思いますが、この２つだけではやはり細かなブロックができないケースがあります。
- 日本語をアルファベットで表記する方法としてローマ字表記がありますが、日本語をひらがな、カタカナで追加した際に自動的にローマ字表記をブロックすることを考えます。
  - 例えばすべての「か」を「ka」と同一視する(normalize)のは予測できないマッチングが増えそうです
  - 単語のマッチ時に現れた「か」を「ka」と同一視する(alias)としても、ローマ字とひらがなが混じった文字列がマッチしてしまいます
- 本来は単語がひらがな、カタカナからなる場合にのみ、全体をローマ字に変換したものも一緒にブロックするようにしたいわけです。synonymはいわば単語単位でのaliasを設定することによりそのような要求にこたえます。
- JPモードにおいては、入力文字列がひらがな、カタカナのみからなる場合にそれをローマ字（ヘボン式、日本式）に変換した文字列も同様に禁止対象として追加しています。

## 独自のチェック機構の実装
- shutup::language::WordCheckerを継承して実装を変更することで独自のチェックを追加できます。
- 具体例はjp.cppを参照してください。
- コードの例
``` C++
class MyWordChecker : public shutup::language::WordChecker {
	//implementations...
}
//MyWordCheckerを使うcheckerを生成する.
shutup::Checker c(nullptr, &shutup::Checker::create<MyWordChecker>);
```

### 変更可能な実装
- 基本的な実装
  - int init()
    - WordCheckerが初期化される際に呼び出されます.
    - 主に禁止語句マッチングの仕組みで説明した、alias, ignore, normalizeの設定を行います。
      - normalize以外は、設定用のAPI, shutup::language::WordChecker::link_alias, set_alias, ignore_glyphsを呼び出して設定してください.
      - normalizeはnormalizer_.push_backを呼び出して設定します。
  - void fin()
    - initで何か割り当てたリソースがあればそれを解放します。
    - link_alias, set_alias, ignore_glyph, およびnormalizer_.push_backの呼び出しについては何も後処理を行う必要はありません。
  - void add_synonym(const char *pattern, Checker &c)
    - 禁止語句マッチングの仕組みで説明した、synonymを行います。
    - patternが外部から禁止語句として設定された時に呼び出されます。patternと一緒に登録したい禁止語句がある場合にはc.add_wordを利用して設定を行ってください。
- ローレベルの実装
  - int normalize(const u8 *in, int ilen, u8 *out, int olen)
    - これをoverrideすることで、normalizeの処理をそのまま置き換えることができます。
    - in, ilenで受け取った文字列で、他の文字と同一視できるものがあれば、変換し、その結果をout, olenに書き込みます。
    - 最終的にoutに書き込まれたバイト数を返してください。
  - int match(const u8 *in, int ilen, const u8 *pattern, int plen, int *ofs)
    - これをoverrideすることで、patricia木を実際にトラバースする時に、ノードに含まれる文字列(pattern, plen)と入力(in, ilen)が一致するかのチェックをそのまま置き換えることができます。
    - ofsには入力の何バイト目までマッチしたかを返し、戻り値としてpatternの何倍と目までマッチしたかを返します。





















